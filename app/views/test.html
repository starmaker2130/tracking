<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width,initial-scale=1.0' />
    <title>Empty RFID | v 0.2.0</title>
    <link rel='stylesheet' type='text/css' href='../css/rfid.css' />
    <script src='../js/jquery-3.2.1.min.js'></script>
    <script src='../js/aframe.min.js'></script>
    <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>
    <script>
        var sessionManager;

        function requestFullScreen(element) { //    makes the application fullscreen on fullscreen equipped browsers
            var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen; // Supports most browsers and their versions.

            if (requestMethod) { // Native full screen.
                requestMethod.call(element);
            } else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
                var wscript = new ActiveXObject("WScript.Shell");
                if (wscript !== null) {
                    wscript.SendKeys("{F11}");
                }
            }
        }

        function initializeSession(data){
            sessionManager = {
                audio: {
                    player: null,
                    isPlaying: false,
                    focus: null,
                    state: 0 // 0 = inactive; 1 = playing; 2 = paused
                },
                application: {
                    focus: 0, // 0 = home; 1 = audio; 2 = visual; 3 = search
                    players: {
                        available: [
                            'audioAR',
                            'visualAR'
                        ],
                        loaded: null
                    }
                },
                visual: {
                    player: null,
                    isPlaying: false,
                    focus: null,
                    state: 0 // 0 = inactive; 1 = playing; 2 = paused
                },
            };

           // loadAREnvironment(0);
            /**/

            sessionManager.audio.focus = 0;
        }
        
        function gotDevices(deviceInfos) {
            var videoSelect = document.querySelector('select#videoSource');
            for (var i = 0; i !== deviceInfos.length; ++i) {
                var deviceInfo = deviceInfos[i];
                var option = document.createElement('option');
                option.value = deviceInfo.deviceId;

                if (deviceInfo.kind === 'videoinput') {
                    option.text = deviceInfo.label || 'camera ' + (videoSelect.length + 1);
                    videoSelect.appendChild(option);
                }
                else {
                    console.log('Found one other kind of source/device: ', deviceInfo);
                }
            }
        }

        function getStream() {
            var videoSelect = document.querySelector('select#videoSource');

            if (window.stream) {
                window.stream.getTracks().forEach(function(track) {
                    track.stop();
                });
            }

            var constraints = {
                video: {
                    deviceId: {exact: videoSelect.value}
                }
            };

            navigator.mediaDevices.getUserMedia(constraints).then(gotStream).catch(handleError);
        }
        
        function gotStream(stream) {
            window.stream = stream; // make stream available to console
            video.srcObject = stream;
            //video.play();
        }

        function handleError(error) {
            console.log('Error: ', error);
        }
        
        $(document).ready(function(){
            initializeSession();

            // FIRST STAGE
            $('#launch-application-page').click(function(){

                console.log('application launch...');

                var elem = document.body;
                //requestFullScreen(elem);

                $(this).animate({
                    height: 0
                }, 2500, function(){
                    $(this).hide();
                     var video = document.getElementById('video');
                    var videoSelect = document.querySelector('select#videoSource');
                    // Get access to the camera!
                    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        // Not adding `{ audio: true }` since we only want video now
                        navigator.mediaDevices.enumerateDevices().then(gotDevices).then(getStream).catch(handleError);

                        videoSelect.onchange = getStream;
                    }
                });
            });

        });
    </script>
</head>
<body>
    <div id='launch-application-page' class='entry-layer overlay'>
        <div id='instructions'>
            tap anywhere
            <div id='logo'></div>
            to launch app
        </div>
    </div>
    <!-- FOR PRODUCTION PURPOSES ONLY-->
    <select id='videoSource'></select>
    <video id="video" autoplay></video>
    <div id='main-app-container' class='viewer-layer'>
        <a-scene embedded id='rfid-experience-container'>
            <a-assets>
                <a-asset-item id='eiffel-mtl' src='../media/model/eiffel-tower.mtl' preload='true' ></a-asset-item>
                <a-asset-item id='eiffel-obj' src='../media/model/eiffel-tower.obj' preload='true' ></a-asset-item>
            </a-assets>
            
            
            <a-text value='18:45' position='0 4 0' align='center' material='color: white;' font='monoid' width='10'></a-text>
            <a-text value='PARIS' position='0 3.3 0' align='center' material='color: white;' font='monoid' width='6'></a-text>
            
            <a-entity obj-model="obj: #eiffel-obj; mtl: #eiffel-mtl;" scale="0.05 0.05 0.05"></a-entity>
            <a-sphere color="white" position="3 2 -2" radius="0.5">
            </a-sphere>
            
            <a-entity geometry='primitive: plane; width: 1.5; height: 0.5;' position='-2 0 0' text='value: new; width: 4; align: center; color: white;' material='color: black;'></a-entity>
            
            <a-entity geometry='primitive: plane; width: 1.5; height: 0.5;' position='2 0 0'  text='value: info; width: 4; align: center; color: white;' material='color: black;'></a-entity>
            <!--<a-entity id='floor'
                        geometry='primitive: plane; width: 100; height: 100;'
                        material='src: #floor-texture; repeat: 100 100;'
                        position='0 0 0'
                        rotation='-90 0 0'>
            </a-entity>-->
            <a-entity position="0 1.5 5">            
                <a-entity camera="active: true" look-controls wasd-controls></a-entity>
            </a-entity>
            <a-sky material='transparent: true; opacity: 0; color: white;'>
            </a-sky>
        </a-scene>
    </div>
</body>
</html>